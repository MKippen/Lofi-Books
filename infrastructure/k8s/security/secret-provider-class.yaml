# SecretProviderClass mounts Key Vault secrets into the backend pod via CSI driver.
# Placeholders ${WORKLOAD_IDENTITY_CLIENT_ID} and ${AZURE_TENANT_ID} are substituted
# by setup-azure.sh using `envsubst` before applying.
# The MSI only has Key Vault Secrets User role â€” read-only, principle of least privilege.
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: lofi-books-secrets
  namespace: lofi-books
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "false"
    clientID: "${WORKLOAD_IDENTITY_CLIENT_ID}"
    keyvaultName: "kv-lofi-books-prod"
    tenantId: "${AZURE_TENANT_ID}"
    objects: |
      array:
        - |
          objectName: openai-api-key
          objectType: secret
        - |
          objectName: msal-client-id
          objectType: secret
  # Syncs Key Vault secrets to a K8s Secret for use as env vars in the pod.
  # Auto-rotated every 5 minutes by the CSI driver (no credential rotation needed).
  secretObjects:
    - secretName: lofi-books-env-secrets
      type: Opaque
      data:
        - objectName: openai-api-key
          key: OPENAI_API_KEY
        - objectName: msal-client-id
          key: MSAL_CLIENT_ID
