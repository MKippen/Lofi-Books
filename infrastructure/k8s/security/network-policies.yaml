# Network isolation for the lofi-books namespace.
# Design: default-deny all ingress, then explicitly allow only what's needed.
# The frontend cannot talk directly to the backend (all traffic routes through ingress).

---
# 1. Default deny all ingress in this namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: lofi-books
spec:
  podSelector: {}
  policyTypes:
    - Ingress

---
# 2. Allow NGINX Ingress Controller → frontend on port 80
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-frontend
  namespace: lofi-books
spec:
  podSelector:
    matchLabels:
      app: lofi-books-frontend
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 80

---
# 3. Allow NGINX Ingress Controller → backend on port 3001
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-backend
  namespace: lofi-books
spec:
  podSelector:
    matchLabels:
      app: lofi-books-api
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 3001

---
# 4. Allow backend egress to external APIs (OpenAI, Microsoft Graph, DNS)
#    and to Key Vault (via HTTPS). Frontend has no egress policy (blocked to backend).
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-egress
  namespace: lofi-books
spec:
  podSelector:
    matchLabels:
      app: lofi-books-api
  policyTypes:
    - Egress
  egress:
    - {}  # Allow all egress: OpenAI API, Microsoft Graph, Key Vault, DNS
